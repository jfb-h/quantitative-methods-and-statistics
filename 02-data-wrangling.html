<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jakob Hoffmann">

<title>Quantitative Methods and Statistics – QMSS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01-introduction.html">Basics of <code>R</code> programming</a></li><li class="breadcrumb-item"><a href="./02-data-wrangling.html">Data wrangling</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Basics of <code>R</code> programming</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to <code>R</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data-wrangling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Data wrangling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Describing data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-data-visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-descriptive-univariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Univariate descriptions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-descriptive-multivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multivariate descriptions</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-gapminder-dataset" id="toc-the-gapminder-dataset" class="nav-link active" data-scroll-target="#the-gapminder-dataset">The gapminder dataset</a></li>
  <li><a href="#loading-the-tidyverse-package" id="toc-loading-the-tidyverse-package" class="nav-link" data-scroll-target="#loading-the-tidyverse-package">Loading the <code>tidyverse</code> package</a></li>
  <li><a href="#loading-data-from-different-formats" id="toc-loading-data-from-different-formats" class="nav-link" data-scroll-target="#loading-data-from-different-formats">Loading data from different formats</a>
  <ul class="collapse">
  <li><a href="#csv-files" id="toc-csv-files" class="nav-link" data-scroll-target="#csv-files">CSV files</a></li>
  <li><a href="#excel-files" id="toc-excel-files" class="nav-link" data-scroll-target="#excel-files">Excel files</a></li>
  <li><a href="#parquet-files" id="toc-parquet-files" class="nav-link" data-scroll-target="#parquet-files">Parquet files</a></li>
  </ul></li>
  <li><a href="#basic-data-wrangling-functions" id="toc-basic-data-wrangling-functions" class="nav-link" data-scroll-target="#basic-data-wrangling-functions">Basic data wrangling functions</a>
  <ul class="collapse">
  <li><a href="#selecting-columns-with-select" id="toc-selecting-columns-with-select" class="nav-link" data-scroll-target="#selecting-columns-with-select">Selecting columns with <code>select</code></a></li>
  <li><a href="#renaming-columns-with-rename" id="toc-renaming-columns-with-rename" class="nav-link" data-scroll-target="#renaming-columns-with-rename">Renaming columns with <code>rename</code></a></li>
  <li><a href="#filtering-rows-with-filter" id="toc-filtering-rows-with-filter" class="nav-link" data-scroll-target="#filtering-rows-with-filter">Filtering rows with <code>filter</code></a></li>
  <li><a href="#dropping-missing-values-with-drop_na" id="toc-dropping-missing-values-with-drop_na" class="nav-link" data-scroll-target="#dropping-missing-values-with-drop_na">Dropping missing values with <code>drop_na</code></a></li>
  <li><a href="#removing-duplicate-rows-with-distinct" id="toc-removing-duplicate-rows-with-distinct" class="nav-link" data-scroll-target="#removing-duplicate-rows-with-distinct">Removing duplicate rows with <code>distinct</code></a></li>
  <li><a href="#sorting-rows-with-arrange" id="toc-sorting-rows-with-arrange" class="nav-link" data-scroll-target="#sorting-rows-with-arrange">Sorting rows with <code>arrange</code></a></li>
  <li><a href="#making-new-columns-with-mutate" id="toc-making-new-columns-with-mutate" class="nav-link" data-scroll-target="#making-new-columns-with-mutate">Making new columns with <code>mutate</code></a></li>
  <li><a href="#grouped-summaries-with-group_by-and-summarize" id="toc-grouped-summaries-with-group_by-and-summarize" class="nav-link" data-scroll-target="#grouped-summaries-with-group_by-and-summarize">Grouped summaries with <code>group_by</code> and <code>summarize</code></a></li>
  <li><a href="#long-and-wide-format-data-with-pivot_wider-and-pivot_longer" id="toc-long-and-wide-format-data-with-pivot_wider-and-pivot_longer" class="nav-link" data-scroll-target="#long-and-wide-format-data-with-pivot_wider-and-pivot_longer">Long and wide format data with <code>pivot_wider</code> and <code>pivot_longer</code></a></li>
  <li><a href="#joining-tables-on-a-common-index" id="toc-joining-tables-on-a-common-index" class="nav-link" data-scroll-target="#joining-tables-on-a-common-index">Joining tables on a common index</a></li>
  </ul></li>
  <li><a href="#data-processing-pipelines" id="toc-data-processing-pipelines" class="nav-link" data-scroll-target="#data-processing-pipelines">Data processing pipelines</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01-introduction.html">Basics of <code>R</code> programming</a></li><li class="breadcrumb-item"><a href="./02-data-wrangling.html">Data wrangling</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Quantitative Methods and Statistics</h1>
<p class="subtitle lead">An applied course using the <code>R</code> programming language</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Jakob Hoffmann </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Economic Geography Group, LMU Munich
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="the-gapminder-dataset" class="level1">
<h1>The gapminder dataset</h1>
<p>The Gapminder dataset contains information about countries’ life expectancy, population, and GDP per capita over time. It was compiled by a Swedish foundation of the same name and is well-suited for demonstrating data analysis techniques because it is a real and insightful dataset that has just enough complexity to be useful without being overwhelming.</p>
<p>The dataset contains the following variables:</p>
<ul>
<li><p><strong>country</strong> : Country names</p></li>
<li><p><strong>continent</strong> : Continental groupings</p></li>
<li><p><strong>year</strong> : Years from 1952 to 2007 (5 year periods)</p></li>
<li><p><strong>lifeExp</strong> : Life expectancy in years</p></li>
<li><p><strong>pop</strong> : Population count</p></li>
<li><p><strong>gdpPercap</strong> : GDP per capita (inflation-adjusted US dollars)</p></li>
</ul>
</section>
<section id="loading-the-tidyverse-package" class="level1">
<h1>Loading the <code>tidyverse</code> package</h1>
<p>The tidyverse is a collection of packages designed to work together seamlessly for data science. Instead of loading individual packages, we can load the whole suite:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If you have not yet installed the <code>tidyverse</code> , you can either use the RStudio interface or run <code>install.packages("tidyverse")</code> in a cell or in the console.</p>
</section>
<section id="loading-data-from-different-formats" class="level1">
<h1>Loading data from different formats</h1>
<p>The first step of any analysis is importing data from some data source into <code>R</code>. Data comes in many formats, and <code>R</code> (or some package) has functions to handle most of them. In the following, we will load the same gapminder data from different file formats to see how this works.</p>
<section id="csv-files" class="level2">
<h2 class="anchored" data-anchor-id="csv-files">CSV files</h2>
<p>CSV (comma-separated values) is probably the most common data exchange format:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df_from_csv <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/gapminder.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1704 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (2): country, continent
dbl (4): year, lifeExp, pop, gdpPercap

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_from_csv</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
   country     continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.
 2 Afghanistan Asia       1957    30.3  9240934      821.
 3 Afghanistan Asia       1962    32.0 10267083      853.
 4 Afghanistan Asia       1967    34.0 11537966      836.
 5 Afghanistan Asia       1972    36.1 13079460      740.
 6 Afghanistan Asia       1977    38.4 14880372      786.
 7 Afghanistan Asia       1982    39.9 12881816      978.
 8 Afghanistan Asia       1987    40.8 13867957      852.
 9 Afghanistan Asia       1992    41.7 16317921      649.
10 Afghanistan Asia       1997    41.8 22227415      635.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>CSV is so common because it is a (deceivingly) simple plain-text format. However, its simplicity means it is somewhat underspecified which can lead to complications. Because of this, reading csv data properly can tricky and messy.</p>
</section>
<section id="excel-files" class="level2">
<h2 class="anchored" data-anchor-id="excel-files">Excel files</h2>
<p>Excel files require a separate package, and for pain-free reading the spreadsheet containing the data should follow a plain, single-header table format. If that is the case, the read command looks similarly simple to the csv case:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df_from_excel <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"data/gapminder.xlsx"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>df_from_excel</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
   country     continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.
 2 Afghanistan Asia       1957    30.3  9240934      821.
 3 Afghanistan Asia       1962    32.0 10267083      853.
 4 Afghanistan Asia       1967    34.0 11537966      836.
 5 Afghanistan Asia       1972    36.1 13079460      740.
 6 Afghanistan Asia       1977    38.4 14880372      786.
 7 Afghanistan Asia       1982    39.9 12881816      978.
 8 Afghanistan Asia       1987    40.8 13867957      852.
 9 Afghanistan Asia       1992    41.7 16317921      649.
10 Afghanistan Asia       1997    41.8 22227415      635.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>The package also has options for reading data from different spreadsheets or from specified ranges of a spreadsheet.</p>
</section>
<section id="parquet-files" class="level2">
<h2 class="anchored" data-anchor-id="parquet-files">Parquet files</h2>
<p>Parquet is a more modern, efficient format that’s becoming increasingly popular:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df_from_parquet <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">"data/gapminder.parquet"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_from_parquet</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
   country     continent  year lifeExp      pop gdpPercap
   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.
 2 Afghanistan Asia       1957    30.3  9240934      821.
 3 Afghanistan Asia       1962    32.0 10267083      853.
 4 Afghanistan Asia       1967    34.0 11537966      836.
 5 Afghanistan Asia       1972    36.1 13079460      740.
 6 Afghanistan Asia       1977    38.4 14880372      786.
 7 Afghanistan Asia       1982    39.9 12881816      978.
 8 Afghanistan Asia       1987    40.8 13867957      852.
 9 Afghanistan Asia       1992    41.7 16317921      649.
10 Afghanistan Asia       1997    41.8 22227415      635.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>Parquet can be used to read huge datasets very quickly and is less ambiguous about data types than csv or excel files, which makes it a much more suitable data exchange format.</p>
<p>Let’s verify these all have the same number of rows and columns with <code>dim()</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(df_from_csv) <span class="sc">==</span> <span class="fu">dim</span>(df_from_excel) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE TRUE</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(df_from_csv) <span class="sc">==</span> <span class="fu">dim</span>(df_from_parquet)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE TRUE</code></pre>
</div>
</div>
<p>From now on, we’ll work with the CSV version and call it simply <code>gapminder</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>gapminder <span class="ot">&lt;-</span> df_from_csv</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="basic-data-wrangling-functions" class="level1">
<h1>Basic data wrangling functions</h1>
<p>The <code>tidyverse</code> way is to have simple functions that do one thing well and which can be combined to produce more complex analyses. The following is an overview of the most essential operations (there are many more).</p>
<section id="selecting-columns-with-select" class="level2">
<h2 class="anchored" data-anchor-id="selecting-columns-with-select">Selecting columns with <code>select</code></h2>
<p>Many real-world datasets come with a huge number of columns, of which you often only need a subset. You can use the <code>select()</code> function to return the input data frame with only the specified columns:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first argument is data frame, rest are column names to keep</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(gapminder, country, year, lifeExp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 3
   country      year lifeExp
   &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;
 1 Afghanistan  1952    28.8
 2 Afghanistan  1957    30.3
 3 Afghanistan  1962    32.0
 4 Afghanistan  1967    34.0
 5 Afghanistan  1972    36.1
 6 Afghanistan  1977    38.4
 7 Afghanistan  1982    39.9
 8 Afghanistan  1987    40.8
 9 Afghanistan  1992    41.7
10 Afghanistan  1997    41.8
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>You can also select by column position, specify ranges of columns, indicate which columns to <em>drop</em> instead of which to keep, or use helper functions like <code>starts_with</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns by position</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(gapminder, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop columns by putting a minus in front</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(gapminder, <span class="sc">-</span>continent, <span class="sc">-</span>pop)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns that start with a string</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(gapminder, <span class="fu">starts_with</span>(<span class="st">"c"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="renaming-columns-with-rename" class="level2">
<h2 class="anchored" data-anchor-id="renaming-columns-with-rename">Renaming columns with <code>rename</code></h2>
<p>Column names aren’t always what you want. If you want to rename some functions and keep all the others as is, use <code>rename()</code> with the pattern <code>new_name = old_name</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(gapminder, <span class="at">life_expectancy =</span> lifeExp, <span class="at">gdp_per_capita =</span> gdpPercap)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
   country     continent  year life_expectancy      pop gdp_per_capita
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;           &lt;dbl&gt;    &lt;dbl&gt;          &lt;dbl&gt;
 1 Afghanistan Asia       1952            28.8  8425333           779.
 2 Afghanistan Asia       1957            30.3  9240934           821.
 3 Afghanistan Asia       1962            32.0 10267083           853.
 4 Afghanistan Asia       1967            34.0 11537966           836.
 5 Afghanistan Asia       1972            36.1 13079460           740.
 6 Afghanistan Asia       1977            38.4 14880372           786.
 7 Afghanistan Asia       1982            39.9 12881816           978.
 8 Afghanistan Asia       1987            40.8 13867957           852.
 9 Afghanistan Asia       1992            41.7 16317921           649.
10 Afghanistan Asia       1997            41.8 22227415           635.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>If you instead want to only keep the columns that you want to rename, you can use <code>select</code> with the same renaming pattern:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(gapminder, <span class="at">life_expectancy =</span> lifeExp, <span class="at">gdp_per_capita =</span> gdpPercap)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 2
   life_expectancy gdp_per_capita
             &lt;dbl&gt;          &lt;dbl&gt;
 1            28.8           779.
 2            30.3           821.
 3            32.0           853.
 4            34.0           836.
 5            36.1           740.
 6            38.4           786.
 7            39.9           978.
 8            40.8           852.
 9            41.7           649.
10            41.8           635.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>The difference is that rename will keep all the other columns while select will only keep the specified ones.</p>
</section>
<section id="filtering-rows-with-filter" class="level2">
<h2 class="anchored" data-anchor-id="filtering-rows-with-filter">Filtering rows with <code>filter</code></h2>
<p>While <code>select</code> is used to pick out certain <em>columns</em>, <code>filter()</code> keeps <em>rows</em> based on certain specified conditions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(gapminder, year <span class="sc">==</span> <span class="dv">2007</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 6
   country     continent  year lifeExp       pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       2007    43.8  31889923      975.
 2 Albania     Europe     2007    76.4   3600523     5937.
 3 Algeria     Africa     2007    72.3  33333216     6223.
 4 Angola      Africa     2007    42.7  12420476     4797.
 5 Argentina   Americas   2007    75.3  40301927    12779.
 6 Australia   Oceania    2007    81.2  20434176    34435.
 7 Austria     Europe     2007    79.8   8199783    36126.
 8 Bahrain     Asia       2007    75.6    708573    29796.
 9 Bangladesh  Asia       2007    64.1 150448339     1391.
10 Belgium     Europe     2007    79.4  10392226    33693.
# ℹ 132 more rows</code></pre>
</div>
</div>
<p>We can use logical operators like <code>&amp;</code> (logical <em>and</em>) or <code>|</code> (logical <em>or</em>) to specify more complex conditions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep rows for Europe and year 2007</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(gapminder, year <span class="sc">==</span> <span class="dv">2007</span> <span class="sc">&amp;</span> continent <span class="sc">==</span> <span class="st">"Europe"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 6
   country                continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;                  &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Albania                Europe     2007    76.4  3600523     5937.
 2 Austria                Europe     2007    79.8  8199783    36126.
 3 Belgium                Europe     2007    79.4 10392226    33693.
 4 Bosnia and Herzegovina Europe     2007    74.9  4552198     7446.
 5 Bulgaria               Europe     2007    73.0  7322858    10681.
 6 Croatia                Europe     2007    75.7  4493312    14619.
 7 Czech Republic         Europe     2007    76.5 10228744    22833.
 8 Denmark                Europe     2007    78.3  5468120    35278.
 9 Finland                Europe     2007    79.3  5238460    33207.
10 France                 Europe     2007    80.7 61083916    30470.
# ℹ 20 more rows</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep rows for Europe or Asia</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(gapminder, continent <span class="sc">==</span> <span class="st">"Europe"</span> <span class="sc">|</span> continent <span class="sc">==</span> <span class="st">"Asia"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 756 × 6
   country     continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.
 2 Afghanistan Asia       1957    30.3  9240934      821.
 3 Afghanistan Asia       1962    32.0 10267083      853.
 4 Afghanistan Asia       1967    34.0 11537966      836.
 5 Afghanistan Asia       1972    36.1 13079460      740.
 6 Afghanistan Asia       1977    38.4 14880372      786.
 7 Afghanistan Asia       1982    39.9 12881816      978.
 8 Afghanistan Asia       1987    40.8 13867957      852.
 9 Afghanistan Asia       1992    41.7 16317921      649.
10 Afghanistan Asia       1997    41.8 22227415      635.
# ℹ 746 more rows</code></pre>
</div>
</div>
<p>If we only want to keep values appearing in a specified list, we can use the <code>%in%</code> operator:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using %in% for multiple values</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(gapminder, country <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Germany"</span>, <span class="st">"France"</span>, <span class="st">"Italy"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 36 × 6
   country continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 France  Europe     1952    67.4 42459667     7030.
 2 France  Europe     1957    68.9 44310863     8663.
 3 France  Europe     1962    70.5 47124000    10560.
 4 France  Europe     1967    71.6 49569000    13000.
 5 France  Europe     1972    72.4 51732000    16107.
 6 France  Europe     1977    73.8 53165019    18293.
 7 France  Europe     1982    74.9 54433565    20294.
 8 France  Europe     1987    76.3 55630100    22066.
 9 France  Europe     1992    77.5 57374179    24704.
10 France  Europe     1997    78.6 58623428    25890.
# ℹ 26 more rows</code></pre>
</div>
</div>
</section>
<section id="dropping-missing-values-with-drop_na" class="level2">
<h2 class="anchored" data-anchor-id="dropping-missing-values-with-drop_na">Dropping missing values with <code>drop_na</code></h2>
<p>The gapminder dataset is clean, but real data often has missing values. <code>drop_na()</code> removes rows with missing data:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create some missing data for demonstration</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>gapminder_with_na <span class="ot">&lt;-</span> gapminder</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>gapminder_with_na<span class="sc">$</span>lifeExp[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with any missing values</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">drop_na</span>(gapminder_with_na)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,699 × 6
   country     continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1977    38.4 14880372      786.
 2 Afghanistan Asia       1982    39.9 12881816      978.
 3 Afghanistan Asia       1987    40.8 13867957      852.
 4 Afghanistan Asia       1992    41.7 16317921      649.
 5 Afghanistan Asia       1997    41.8 22227415      635.
 6 Afghanistan Asia       2002    42.1 25268405      727.
 7 Afghanistan Asia       2007    43.8 31889923      975.
 8 Albania     Europe     1952    55.2  1282697     1601.
 9 Albania     Europe     1957    59.3  1476505     1942.
10 Albania     Europe     1962    64.8  1728137     2313.
# ℹ 1,689 more rows</code></pre>
</div>
</div>
<p>We can also specify to only drop rows with missing values in certain columns:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">drop_na</span>(gapminder_with_na, lifeExp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,699 × 6
   country     continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1977    38.4 14880372      786.
 2 Afghanistan Asia       1982    39.9 12881816      978.
 3 Afghanistan Asia       1987    40.8 13867957      852.
 4 Afghanistan Asia       1992    41.7 16317921      649.
 5 Afghanistan Asia       1997    41.8 22227415      635.
 6 Afghanistan Asia       2002    42.1 25268405      727.
 7 Afghanistan Asia       2007    43.8 31889923      975.
 8 Albania     Europe     1952    55.2  1282697     1601.
 9 Albania     Europe     1957    59.3  1476505     1942.
10 Albania     Europe     1962    64.8  1728137     2313.
# ℹ 1,689 more rows</code></pre>
</div>
</div>
<p>Note that for statistical analysis, simply dropping rows can be dangerous because it might bias the results (why are these values missing? For which observations are they missing?). Accordingly, you should always make sure that you at least understand the extent and the pattern of missing values in your dataset before dropping incomplete rows.</p>
</section>
<section id="removing-duplicate-rows-with-distinct" class="level2">
<h2 class="anchored" data-anchor-id="removing-duplicate-rows-with-distinct">Removing duplicate rows with <code>distinct</code></h2>
<p><code>distinct()</code> removes duplicate rows with respect to the specified columns. E.g., if we only wanted a list of continents and countries, we could do the following:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique combinations of continent and year</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(gapminder, continent, country)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 2
   continent country    
   &lt;chr&gt;     &lt;chr&gt;      
 1 Asia      Afghanistan
 2 Europe    Albania    
 3 Africa    Algeria    
 4 Africa    Angola     
 5 Americas  Argentina  
 6 Oceania   Australia  
 7 Europe    Austria    
 8 Asia      Bahrain    
 9 Asia      Bangladesh 
10 Europe    Belgium    
# ℹ 132 more rows</code></pre>
</div>
</div>
<p>Note that this drops all the other columns. If you want to keep the first value for the other columns, specify <code>.keep_all = TRUE</code> (note the dot in the argument name):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(gapminder, country, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 6
   country     continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.
 2 Albania     Europe     1952    55.2  1282697     1601.
 3 Algeria     Africa     1952    43.1  9279525     2449.
 4 Angola      Africa     1952    30.0  4232095     3521.
 5 Argentina   Americas   1952    62.5 17876956     5911.
 6 Australia   Oceania    1952    69.1  8691212    10040.
 7 Austria     Europe     1952    66.8  6927772     6137.
 8 Bahrain     Asia       1952    50.9   120447     9867.
 9 Bangladesh  Asia       1952    37.5 46886859      684.
10 Belgium     Europe     1952    68    8730405     8343.
# ℹ 132 more rows</code></pre>
</div>
</div>
</section>
<section id="sorting-rows-with-arrange" class="level2">
<h2 class="anchored" data-anchor-id="sorting-rows-with-arrange">Sorting rows with <code>arrange</code></h2>
<p><code>arrange()</code> sorts rows by one or more columns:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by life expectancy</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(gapminder, lifeExp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
   country      continent  year lifeExp     pop gdpPercap
   &lt;chr&gt;        &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
 1 Rwanda       Africa     1992    23.6 7290203      737.
 2 Afghanistan  Asia       1952    28.8 8425333      779.
 3 Gambia       Africa     1952    30    284320      485.
 4 Angola       Africa     1952    30.0 4232095     3521.
 5 Sierra Leone Africa     1952    30.3 2143249      880.
 6 Afghanistan  Asia       1957    30.3 9240934      821.
 7 Cambodia     Asia       1977    31.2 6978607      525.
 8 Mozambique   Africa     1952    31.3 6446316      469.
 9 Sierra Leone Africa     1957    31.6 2295678     1004.
10 Burkina Faso Africa     1952    32.0 4469979      543.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>We can also sort by descending order using the <code>desc()</code> helper function and of course sort by multiple columns, in the specified order:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by life expectancy in descending order</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(gapminder, <span class="fu">desc</span>(lifeExp))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
   country          continent  year lifeExp       pop gdpPercap
   &lt;chr&gt;            &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1 Japan            Asia       2007    82.6 127467972    31656.
 2 Hong Kong, China Asia       2007    82.2   6980412    39725.
 3 Japan            Asia       2002    82   127065841    28605.
 4 Iceland          Europe     2007    81.8    301931    36181.
 5 Switzerland      Europe     2007    81.7   7554661    37506.
 6 Hong Kong, China Asia       2002    81.5   6762476    30209.
 7 Australia        Oceania    2007    81.2  20434176    34435.
 8 Spain            Europe     2007    80.9  40448191    28821.
 9 Sweden           Europe     2007    80.9   9031088    33860.
10 Israel           Asia       2007    80.7   6426679    25523.
# ℹ 1,694 more rows</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by multiple columns</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(gapminder, year, <span class="fu">desc</span>(lifeExp))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
   country        continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;          &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Norway         Europe     1952    72.7  3327728    10095.
 2 Iceland        Europe     1952    72.5   147962     7268.
 3 Netherlands    Europe     1952    72.1 10381988     8942.
 4 Sweden         Europe     1952    71.9  7124673     8528.
 5 Denmark        Europe     1952    70.8  4334000     9692.
 6 Switzerland    Europe     1952    69.6  4815000    14734.
 7 New Zealand    Oceania    1952    69.4  1994794    10557.
 8 United Kingdom Europe     1952    69.2 50430000     9980.
 9 Australia      Oceania    1952    69.1  8691212    10040.
10 Canada         Americas   1952    68.8 14785584    11367.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
</section>
<section id="making-new-columns-with-mutate" class="level2">
<h2 class="anchored" data-anchor-id="making-new-columns-with-mutate">Making new columns with <code>mutate</code></h2>
<p><code>mutate()</code> creates new columns or modifies existing ones. E.g., to create a column with the total GDP (instead of per-capita GDP), we can create a new column containing the product of <code>gdpPercap</code> and <code>pop</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(gapminder, <span class="at">total_gdp =</span> gdpPercap <span class="sc">*</span> pop)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 7
   country     continent  year lifeExp      pop gdpPercap    total_gdp
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.  6567086330.
 2 Afghanistan Asia       1957    30.3  9240934      821.  7585448670.
 3 Afghanistan Asia       1962    32.0 10267083      853.  8758855797.
 4 Afghanistan Asia       1967    34.0 11537966      836.  9648014150.
 5 Afghanistan Asia       1972    36.1 13079460      740.  9678553274.
 6 Afghanistan Asia       1977    38.4 14880372      786. 11697659231.
 7 Afghanistan Asia       1982    39.9 12881816      978. 12598563401.
 8 Afghanistan Asia       1987    40.8 13867957      852. 11820990309.
 9 Afghanistan Asia       1992    41.7 16317921      649. 10595901589.
10 Afghanistan Asia       1997    41.8 22227415      635. 14121995875.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>You can create multiple columns at once and reference newly created columns:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(gapminder,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">total_gdp =</span> gdpPercap <span class="sc">*</span> pop,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">gdp_billions =</span> total_gdp <span class="sc">/</span> <span class="fl">1e9</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">gdp_trillions =</span> gdp_billions <span class="sc">/</span> <span class="dv">1000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 9
   country     continent  year lifeExp      pop gdpPercap total_gdp gdp_billions
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.   6.57e 9         6.57
 2 Afghanistan Asia       1957    30.3  9240934      821.   7.59e 9         7.59
 3 Afghanistan Asia       1962    32.0 10267083      853.   8.76e 9         8.76
 4 Afghanistan Asia       1967    34.0 11537966      836.   9.65e 9         9.65
 5 Afghanistan Asia       1972    36.1 13079460      740.   9.68e 9         9.68
 6 Afghanistan Asia       1977    38.4 14880372      786.   1.17e10        11.7 
 7 Afghanistan Asia       1982    39.9 12881816      978.   1.26e10        12.6 
 8 Afghanistan Asia       1987    40.8 13867957      852.   1.18e10        11.8 
 9 Afghanistan Asia       1992    41.7 16317921      649.   1.06e10        10.6 
10 Afghanistan Asia       1997    41.8 22227415      635.   1.41e10        14.1 
# ℹ 1,694 more rows
# ℹ 1 more variable: gdp_trillions &lt;dbl&gt;</code></pre>
</div>
</div>
<p>A particularly useful helper function for creating new columns is <code>case_when()</code>, which let’s you specify conditional logic by specifying <code>condition ~ value</code> pairs. For example, we could assign continents to different groups:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(gapminder,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">continent_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>     continent <span class="sc">==</span> <span class="st">"Europe"</span> <span class="sc">|</span> continent <span class="sc">==</span> <span class="st">"America"</span> <span class="sc">~</span> <span class="st">"West"</span>,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>     continent <span class="sc">==</span> <span class="st">"Asia"</span> <span class="sc">~</span> <span class="st">"East"</span>,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>     continent <span class="sc">==</span> <span class="st">"Africa"</span> <span class="sc">~</span> <span class="st">"South"</span>,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>     <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 7
   country     continent  year lifeExp      pop gdpPercap continent_group
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;          
 1 Afghanistan Asia       1952    28.8  8425333      779. East           
 2 Afghanistan Asia       1957    30.3  9240934      821. East           
 3 Afghanistan Asia       1962    32.0 10267083      853. East           
 4 Afghanistan Asia       1967    34.0 11537966      836. East           
 5 Afghanistan Asia       1972    36.1 13079460      740. East           
 6 Afghanistan Asia       1977    38.4 14880372      786. East           
 7 Afghanistan Asia       1982    39.9 12881816      978. East           
 8 Afghanistan Asia       1987    40.8 13867957      852. East           
 9 Afghanistan Asia       1992    41.7 16317921      649. East           
10 Afghanistan Asia       1997    41.8 22227415      635. East           
# ℹ 1,694 more rows</code></pre>
</div>
</div>
</section>
<section id="grouped-summaries-with-group_by-and-summarize" class="level2">
<h2 class="anchored" data-anchor-id="grouped-summaries-with-group_by-and-summarize">Grouped summaries with <code>group_by</code> and <code>summarize</code></h2>
<p>One of the most powerful patterns is grouping data and calculating summaries for each group. The first step is grouping a data frame:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Average life expectancy by continent</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>gapminder_grouped <span class="ot">&lt;-</span> <span class="fu">group_by</span>(gapminder, continent)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>gapminder_grouped</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
# Groups:   continent [5]
   country     continent  year lifeExp      pop gdpPercap
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 Afghanistan Asia       1952    28.8  8425333      779.
 2 Afghanistan Asia       1957    30.3  9240934      821.
 3 Afghanistan Asia       1962    32.0 10267083      853.
 4 Afghanistan Asia       1967    34.0 11537966      836.
 5 Afghanistan Asia       1972    36.1 13079460      740.
 6 Afghanistan Asia       1977    38.4 14880372      786.
 7 Afghanistan Asia       1982    39.9 12881816      978.
 8 Afghanistan Asia       1987    40.8 13867957      852.
 9 Afghanistan Asia       1992    41.7 16317921      649.
10 Afghanistan Asia       1997    41.8 22227415      635.
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>The result doesn’t look much different than the original data frame. But if you look closely, you will see that it is marked as being grouped by continent, with a total of [5] groups. The next step is to compute one or more summaries for each of the groups:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize</span>(gapminder_grouped, </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">count =</span> <span class="fu">n</span>(), </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">mean_lifeexp =</span> <span class="fu">mean</span>(lifeExp))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  continent count mean_lifeexp
  &lt;chr&gt;     &lt;int&gt;        &lt;dbl&gt;
1 Africa      624         48.9
2 Americas    300         64.7
3 Asia        396         60.1
4 Europe      360         71.9
5 Oceania      24         74.3</code></pre>
</div>
</div>
<p>We will come back to this soon in the context of more complex analysis pipelines.</p>
<p>Because counting rows by group is such a common practice, there is a function <code>count()</code> which is a shortcut for <code>group_by()</code> + <code>summarize(n = n())</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count observations by continent</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(gapminder, continent)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  continent     n
  &lt;chr&gt;     &lt;int&gt;
1 Africa      624
2 Americas    300
3 Asia        396
4 Europe      360
5 Oceania      24</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count with sorting</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(gapminder, continent, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  continent     n
  &lt;chr&gt;     &lt;int&gt;
1 Africa      624
2 Asia        396
3 Europe      360
4 Americas    300
5 Oceania      24</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count by multiple variables</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(gapminder, continent, year)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 3
   continent  year     n
   &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;
 1 Africa     1952    52
 2 Africa     1957    52
 3 Africa     1962    52
 4 Africa     1967    52
 5 Africa     1972    52
 6 Africa     1977    52
 7 Africa     1982    52
 8 Africa     1987    52
 9 Africa     1992    52
10 Africa     1997    52
# ℹ 50 more rows</code></pre>
</div>
</div>
<p>Many of the tidyverse functions respect grouping structure, such as <code>filter()</code>. If we group by continent, for example, we can see that the filter below uses the maximum <em>within each group</em> and returns the row with the highest GDP for each continent:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">group_by</span>(gapminder, continent) <span class="sc">|&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(gdpPercap <span class="sc">==</span> <span class="fu">max</span>(gdpPercap))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 6
# Groups:   continent [5]
  country       continent  year lifeExp       pop gdpPercap
  &lt;chr&gt;         &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 Australia     Oceania    2007    81.2  20434176    34435.
2 Kuwait        Asia       1957    58.0    212846   113523.
3 Libya         Africa     1977    57.4   2721783    21951.
4 Norway        Europe     2007    80.2   4627926    49357.
5 United States Americas   2007    78.2 301139947    42952.</code></pre>
</div>
</div>
<p>Because this kind of operation is common, there is even a specialized function called <code>slice_max()</code> which lets you pick out the top n values according to some variable. Here’s an example of how to get the top 3 most populous countries for each continent in the year 2007:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>gapminder_2007 <span class="ot">&lt;-</span> <span class="fu">filter</span>(gapminder, year <span class="sc">==</span> <span class="dv">2007</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="ot">&lt;-</span> <span class="fu">group_by</span>(gapminder_2007, continent)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">slice_max</span>(df_grouped, pop, <span class="at">n =</span> <span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 6
# Groups:   continent [5]
   country       continent  year lifeExp        pop gdpPercap
   &lt;chr&gt;         &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
 1 Nigeria       Africa     2007    46.9  135031164     2014.
 2 Egypt         Africa     2007    71.3   80264543     5581.
 3 Ethiopia      Africa     2007    52.9   76511887      691.
 4 United States Americas   2007    78.2  301139947    42952.
 5 Brazil        Americas   2007    72.4  190010647     9066.
 6 Mexico        Americas   2007    76.2  108700891    11978.
 7 China         Asia       2007    73.0 1318683096     4959.
 8 India         Asia       2007    64.7 1110396331     2452.
 9 Indonesia     Asia       2007    70.6  223547000     3541.
10 Germany       Europe     2007    79.4   82400996    32170.
11 Turkey        Europe     2007    71.8   71158647     8458.
12 France        Europe     2007    80.7   61083916    30470.
13 Australia     Oceania    2007    81.2   20434176    34435.
14 New Zealand   Oceania    2007    80.2    4115771    25185.</code></pre>
</div>
</div>
<p>Notice also how the output is still grouped. If you want to drop groups so that operations which come afterwards are ungrouped, many functions have arguments for that (look at their help page).</p>
</section>
<section id="long-and-wide-format-data-with-pivot_wider-and-pivot_longer" class="level2">
<h2 class="anchored" data-anchor-id="long-and-wide-format-data-with-pivot_wider-and-pivot_longer">Long and wide format data with <code>pivot_wider</code> and <code>pivot_longer</code></h2>
<p>Data can be organized in “long” format (one observation per row) or “wide” format (multiple observations per row spread across different columns). If that seems a little abstract, here’s a picture showing the difference:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://d3-graph-gallery.com/img/other/long_vs_wide_data_format.png" class="img-fluid figure-img" alt="Long vs. wide format data"></p>
<figcaption>Long vs.&nbsp;wide format data (source: graph gallery)</figcaption>
</figure>
</div>
<p>Here is how we can switch between the two representations using the <code>pivot_wider()</code> function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>gapminder_wide <span class="ot">&lt;-</span> <span class="fu">pivot_wider</span>(gapminder,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">id_cols =</span> country,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">names_from =</span> year, </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">values_from =</span> lifeExp)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>gapminder_wide</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 13
   country `1952` `1957` `1962` `1967` `1972` `1977` `1982` `1987` `1992` `1997`
   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 Afghan…   28.8   30.3   32.0   34.0   36.1   38.4   39.9   40.8   41.7   41.8
 2 Albania   55.2   59.3   64.8   66.2   67.7   68.9   70.4   72     71.6   73.0
 3 Algeria   43.1   45.7   48.3   51.4   54.5   58.0   61.4   65.8   67.7   69.2
 4 Angola    30.0   32.0   34     36.0   37.9   39.5   39.9   39.9   40.6   41.0
 5 Argent…   62.5   64.4   65.1   65.6   67.1   68.5   69.9   70.8   71.9   73.3
 6 Austra…   69.1   70.3   70.9   71.1   71.9   73.5   74.7   76.3   77.6   78.8
 7 Austria   66.8   67.5   69.5   70.1   70.6   72.2   73.2   74.9   76.0   77.5
 8 Bahrain   50.9   53.8   56.9   59.9   63.3   65.6   69.1   70.8   72.6   73.9
 9 Bangla…   37.5   39.3   41.2   43.5   45.3   46.9   50.0   52.8   56.0   59.4
10 Belgium   68     69.2   70.2   70.9   71.4   72.8   73.9   75.4   76.5   77.5
# ℹ 132 more rows
# ℹ 2 more variables: `2002` &lt;dbl&gt;, `2007` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Here, <code>id_cols</code> refers to the column(s) that <em>identify</em> the new rows, <code>names_from</code> specifies from which column the new column <em>names</em> in the wide table should be taken, and <code>values_from</code> specifies from which column the <em>values</em> to populate the new columns should be taken.</p>
<p>To convert back to long format, we can use the <code>pivot_longer()</code> function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(gapminder_wide, <span class="sc">-</span>country)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 3
   country     name  value
   &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;
 1 Afghanistan 1952   28.8
 2 Afghanistan 1957   30.3
 3 Afghanistan 1962   32.0
 4 Afghanistan 1967   34.0
 5 Afghanistan 1972   36.1
 6 Afghanistan 1977   38.4
 7 Afghanistan 1982   39.9
 8 Afghanistan 1987   40.8
 9 Afghanistan 1992   41.7
10 Afghanistan 1997   41.8
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>Here, it is simpler to just specify the columns which <em>not</em> to stack on top of each other, which in our case is just the country column used as identifier in the last step. You can see that the grouping column and the value column just have the generic names <code>name</code> and <code>value</code>, which you can change with the <code>names_to</code> and <code>values_to</code> arguments.</p>
<p>The <code>tidyverse</code> generally prefers long format for analysis (e.g.&nbsp;visualization), but sometimes wide format is more efficient for storage or more useful for presentation.</p>
</section>
<section id="joining-tables-on-a-common-index" class="level2">
<h2 class="anchored" data-anchor-id="joining-tables-on-a-common-index">Joining tables on a common index</h2>
<p>Often data is spread across multiple tables. Let’s create a second dataset with hypothetical continent identifiers:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>continent_codes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">continent =</span> <span class="fu">c</span>(<span class="st">"Africa"</span>, <span class="st">"Americas"</span>, <span class="st">"Asia"</span>, <span class="st">"Europe"</span>, <span class="st">"Oceania"</span>),</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">continent_code =</span> <span class="fu">c</span>(<span class="st">"AF"</span>, <span class="st">"AM"</span>, <span class="st">"AS"</span>, <span class="st">"EU"</span>, <span class="st">"OC"</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>continent_codes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  continent continent_code
1    Africa             AF
2  Americas             AM
3      Asia             AS
4    Europe             EU
5   Oceania             OC</code></pre>
</div>
</div>
<p>We can add this identifier column to our main data frame by matching the <code>continent</code> column in both datasets. This operation is generally called a <em>join</em> - here we perform a <em>left</em> join, which means we want to keep all entries in the first (left) data frame, even if there is no matching identifier in the second (right) data frame. In that case, missing values will be inserted for the rows without a match.</p>
<p>To perform the left join, use the <code>left_join()</code> function with the two datasets and by specifying the common column with the by keyword:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(gapminder, continent_codes, <span class="at">by =</span> <span class="st">"continent"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 7
   country     continent  year lifeExp      pop gdpPercap continent_code
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;         
 1 Afghanistan Asia       1952    28.8  8425333      779. AS            
 2 Afghanistan Asia       1957    30.3  9240934      821. AS            
 3 Afghanistan Asia       1962    32.0 10267083      853. AS            
 4 Afghanistan Asia       1967    34.0 11537966      836. AS            
 5 Afghanistan Asia       1972    36.1 13079460      740. AS            
 6 Afghanistan Asia       1977    38.4 14880372      786. AS            
 7 Afghanistan Asia       1982    39.9 12881816      978. AS            
 8 Afghanistan Asia       1987    40.8 13867957      852. AS            
 9 Afghanistan Asia       1992    41.7 16317921      649. AS            
10 Afghanistan Asia       1997    41.8 22227415      635. AS            
# ℹ 1,694 more rows</code></pre>
</div>
</div>
<p>If the common identifier column is called differently in the two datasets, you can pass something like this to by: <code>c("left_name" = "right_name")</code> .</p>
</section>
</section>
<section id="data-processing-pipelines" class="level1">
<h1>Data processing pipelines</h1>
<p>We have now seen the most common data processing functions. For most real analyses, we need to combine at least some of them to clean up a messy data set or reshape input data to our needs. Let’s say that we want to only look at the development of GDP in European countries, which we want to show in wide format. We have learned that we can use <code>filter</code>, <code>select</code> and <code>pivot_wider</code> for that:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter rows to only Europe</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>gapminder_europe <span class="ot">&lt;-</span> <span class="fu">filter</span>(gapminder, continent <span class="sc">==</span> <span class="st">"Europe"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># select columns</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>gapminder_europe_gdp <span class="ot">&lt;-</span> <span class="fu">select</span>(gapminder_europe, country, year, gdpPercap)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create wide format table</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>gapminder_europe_gdp_wide <span class="ot">&lt;-</span> <span class="fu">pivot_wider</span>(gapminder_europe_gdp,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">names_from =</span> year, </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">values_from =</span> gdpPercap)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>gapminder_europe_gdp_wide</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 13
   country `1952` `1957` `1962` `1967` `1972` `1977` `1982` `1987` `1992` `1997`
   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 Albania  1601.  1942.  2313.  2760.  3313.  3533.  3631.  3739.  2497.  3193.
 2 Austria  6137.  8843. 10751. 12835. 16662. 19749. 21597. 23688. 27042. 29096.
 3 Belgium  8343.  9715. 10991. 13149. 16672. 19118. 20980. 22526. 25576. 27561.
 4 Bosnia…   974.  1354.  1710.  2172.  2860.  3528.  4127.  4314.  2547.  4766.
 5 Bulgar…  2444.  3009.  4254.  5577.  6597.  7612.  8224.  8240.  6303.  5970.
 6 Croatia  3119.  4338.  5478.  6960.  9164. 11305. 13222. 13823.  8448.  9876.
 7 Czech …  6876.  8256. 10137. 11399. 13108. 14800. 15377. 16310. 14297. 16049.
 8 Denmark  9692. 11100. 13583. 15937. 18866. 20423. 21688. 25116. 26407. 29804.
 9 Finland  6425.  7545.  9372. 10922. 14359. 15605. 18533. 21141. 20647. 23724.
10 France   7030.  8663. 10560. 13000. 16107. 18293. 20294. 22066. 24704. 25890.
# ℹ 20 more rows
# ℹ 2 more variables: `2002` &lt;dbl&gt;, `2007` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>This works but seems quite cumbersome and repetitive and we don’t really need all the intermediate variables we created along the way. Instead, we can build a data <em>pipeline</em>, where we pipe the output from the previous function directly into the next function (specifically, as the first argument). We do this with the <strong>pipe operator</strong> <code>|&gt;</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a> gapminder <span class="sc">|&gt;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(continent <span class="sc">==</span> <span class="st">"Europe"</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(country, year, gdpPercap) <span class="sc">|&gt;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, <span class="at">values_from =</span> gdpPercap)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 13
   country `1952` `1957` `1962` `1967` `1972` `1977` `1982` `1987` `1992` `1997`
   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 Albania  1601.  1942.  2313.  2760.  3313.  3533.  3631.  3739.  2497.  3193.
 2 Austria  6137.  8843. 10751. 12835. 16662. 19749. 21597. 23688. 27042. 29096.
 3 Belgium  8343.  9715. 10991. 13149. 16672. 19118. 20980. 22526. 25576. 27561.
 4 Bosnia…   974.  1354.  1710.  2172.  2860.  3528.  4127.  4314.  2547.  4766.
 5 Bulgar…  2444.  3009.  4254.  5577.  6597.  7612.  8224.  8240.  6303.  5970.
 6 Croatia  3119.  4338.  5478.  6960.  9164. 11305. 13222. 13823.  8448.  9876.
 7 Czech …  6876.  8256. 10137. 11399. 13108. 14800. 15377. 16310. 14297. 16049.
 8 Denmark  9692. 11100. 13583. 15937. 18866. 20423. 21688. 25116. 26407. 29804.
 9 Finland  6425.  7545.  9372. 10922. 14359. 15605. 18533. 21141. 20647. 23724.
10 France   7030.  8663. 10560. 13000. 16107. 18293. 20294. 22066. 24704. 25890.
# ℹ 20 more rows
# ℹ 2 more variables: `2002` &lt;dbl&gt;, `2007` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Notice how we omit the first argument (i.e., the dataset to operate on) in each function call. We can do that, because the pipe operator <code>|&gt;</code> places the previous result there (i.e., whatever is returned to the left of the operator).</p>
<p>This is very powerful and you should definitely get used to writing pipelines like this, as they are one of the most fundamental building blocks of efficient data wrangling with the tidyverse and elsewhere.</p>
</section>
<section id="exercises" class="level1">
<h1>Exercises</h1>
<ol type="1">
<li><p>Load the gapminder dataset and explore its structure using <code>glimpse()</code>.</p></li>
<li><p>Select only the country, year, and population columns.</p></li>
<li><p>Filter for data from Asian or American countries in the year 2007.</p></li>
<li><p>Which are the top 5 most populous countries in 2002?</p></li>
<li><p>Create a new column called <code>gdp_category</code> that categorizes countries as “High” (gdpPercap &gt; 10000), “Medium” (between 3000 and 10000), or “Low” (&lt; 3000) GDP.</p></li>
<li><p>Calculate the average life expectancy for each continent in 2007.</p></li>
<li><p>Count how many countries are in each continent.</p></li>
<li><p>Find the richest country in each continent for the year 2007.</p></li>
<li><p>Create a pipeline that: calculates total GDP, groups by continent, and calculates the total GDP per continent and year.</p></li>
<li><p>Create a wide format dataset showing life expectancy for each country (rows) across different years (columns), but only for countries that start with “A”.</p></li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jfb-h\.github\.io\/quantitative-methods-and-statistics\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>